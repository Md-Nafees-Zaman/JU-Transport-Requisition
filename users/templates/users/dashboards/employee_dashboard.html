{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Dashboard Header with Quick Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Employee Dashboard <small class="text-muted">{{ request.user.department }} Department</small></h1>
            <p class="text-muted">Employee ID: {{ request.user.employee_ID }}</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'profile' %}" class="btn btn-primary">
                <i class="bi bi-person-gear"></i> My Profile
            </a>
            <a href="{% url 'reserve_transport' %}" class="btn btn-outline-info">
                <i class="bi bi-car-front-fill"></i> Reserve Transport
            </a>
        </div>
    </div>

    <!-- Workflow Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h5 class="card-title">Pending Requisitions</h5>
                    <h2 class="text-primary">{{ pending_requisitions }}</h2>
                    <small class="text-muted">Awaiting Approval</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h5 class="card-title">Approved Requests</h5>
                    <h2 class="text-success">{{ approved_requests }}</h2>
                    <small class="text-muted">This Month</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h5 class="card-title">Upcoming Transports</h5>
                    <h2 class="text-warning">{{ upcoming_transports }}</h2>
                    <small class="text-muted">Scheduled</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title">Team Members</h5>
                    <h2 class="text-info">{{ team_members }}</h2>
                    <small class="text-muted">In Department</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Requisition Management Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-clipboard-check"></i> My Requisitions
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Req ID</th>
                            <th>Date</th>
                            <th>Purpose</th>
                            <th>Status</th>
                            <th>Transport Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in recent_requisitions %}
                        <tr>
                            <td>#{{ req.id }}</td>
                            <td>{{ req.created_at|date:"d M Y" }}</td>
                            <td>{{ req.purpose|truncatechars:30 }}</td>
                            <td>
                                <span class="badge bg-{{ req.status_badge }}">
                                    {{ req.get_status_display }}
                                </span>
                            </td>
                            <td>{{ req.transport_date|date:"d M Y" }}</td>
                            <td>
                                <a href="{% url 'requisition_detail' req.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">No recent requisitions</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dashboard Content Row -->
    <div class="row">
        <!-- Transport Schedule -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-calendar-event"></i> Upcoming Transport Schedule
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for schedule in transport_schedule %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ schedule.purpose }}</h6>
                                <small class="text-muted">
                                    {{ schedule.transport_date|date:"D, d M Y" }} â€¢ {{ schedule.vehicle_type }}
                                </small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                {{ schedule.get_status_display }}
                            </span>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted">No upcoming transports</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Center -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-files"></i> Document Center
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="bi bi-upload"></i>
                                <strong>{{ pending_docs }}</strong> Pending Uploads
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i>
                                <strong>{{ approved_docs }}</strong> Approved Documents
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="bi bi-upload"></i> Upload New Document
                        </button>
                        {% comment %} <a href="{% url 'document_center' %}" class="btn btn-outline-secondary"> {% endcomment %}
                            <i class="bi bi-archive"></i> View Document Archive
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance & Analytics -->
    <div class="card border-success mb-4">
        <div class="card-header bg-success text-white">
            <i class="bi bi-graph-up-arrow"></i> Requisition Analytics
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Monthly Summary</h5>
                    <canvas id="requisitionChart" style="height: 250px;"></canvas>
                </div>
                <div class="col-md-6">
                    <h5>Performance Metrics</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            Approval Rate
                            <span class="badge bg-primary">{{ approval_rate }}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            Avg. Processing Time
                            <span>{{ avg_processing_time }} days</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            Compliance Score
                            <span class="badge bg-success">{{ compliance_score }}/10</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload"></i> Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="documentUploadForm">
                    <div class="mb-3">
                        <label class="form-label">Select Document Type</label>
                        <select class="form-select">
                            <option>Travel Authorization</option>
                            <option>Expense Report</option>
                            <option>Approval Letter</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Upload File</label>
                        <input type="file" class="form-control" accept=".pdf,.doc,.docx">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-cloud-upload"></i> Upload Document
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Charting Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('requisitionChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ requisition_months|safe }},
            datasets: [{
                label: 'Monthly Requisitions',
                data: {{ requisition_counts|safe }},
                backgroundColor: '#198754',
                borderColor: '#146c43',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
});
</script>

<style>
.card-header { font-weight: 500; }
.list-group-item h6 { font-size: 0.95rem; }
.badge-status { font-size: 0.8rem; padding: 0.35em 0.65em; }
</style>
{% endblock %}
